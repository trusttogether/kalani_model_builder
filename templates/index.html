<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kalani Model Builder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3">Kalani Model Builder</h1>
          <p class="text-muted mb-0">Fill out every blue-cell input below, then click Generate to refresh the workbook.</p>
        </div>
        <div class="text-end">
          <a class="btn btn-outline-primary {% if not has_output %}disabled{% endif %}"
             href="{% if has_output %}/download{% else %}#{% endif %}">Download Latest Workbook</a>
        </div>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="post" enctype="multipart/form-data" class="card p-4 shadow-sm bg-white" id="kalani-form">
        <section class="mb-4">
          <h2 class="h5">1. Template & Output</h2>
          <div class="row g-3 mb-3">
            <div class="col-md-12">
              <label class="form-label">Template Type</label>
              <div class="input-group">
                <select name="template_type" class="form-select">
                  {% for slug, meta in template_options.items() %}
                    <option value="{{ slug }}" {% if project.get('template_type') == slug %}selected{% endif %}>
                      {{ meta.label }}
                    </option>
                  {% endfor %}
                </select>
                <button class="btn btn-outline-secondary" name="action" value="load_template">Load Template Inputs</button>
              </div>
              {% set selected_meta = template_options.get(project.get('template_type')) %}
              {% if selected_meta %}
                <div class="form-text">{{ selected_meta.description }}</div>
              {% endif %}
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Template (.xlsx)</label>
              <input type="file" name="template_file" class="form-control" accept=".xlsx,.xlsm">
            </div>
            <div class="col-md-6">
              <label class="form-label">Output filename</label>
              <input name="output_path" class="form-control" value="{{ project.get('output','updated_kalani_model_v2.xlsx') }}">
            </div>
          </div>
        </section>

        <section class="mb-4">
          <h2 class="h5">2. Summary Inputs</h2>
          <div class="row g-3">
            {% set summary_fields = [
              ('property_name','Property Name'),
              ('address','Address'),
              ('city_state_zip','City, State'),
              ('room_count','Room Count'),
              ('gross_square_feet','Gross SqFt'),
              ('analysis_start_month','Analysis Start (Month)'),
              ('analysis_start_year','Analysis Start (Year)'),
              ('operations_start_month','Operations Start (Month)'),
              ('operations_start_year','Operations Start (Year)'),
              ('hold_period_years','Hold Period (Years)'),
              ('exit_cap_rate','Exit Cap Rate'),
              ('sale_cost_rate','Sale Cost Rate'),
              ('mezz_ltc','Mezz LTC'),
            ] %}
            {% for field, label in summary_fields %}
              <div class="col-md-3">
                <label class="form-label">{{ label }}</label>
                <input name="{{ field }}" class="form-control" value="{{ summary.get(field,'') }}">
              </div>
            {% endfor %}
          </div>
        </section>

        <section class="mb-4">
          <h2 class="h5">3. Budget</h2>
          {% for group, entries in budget.items() %}
            <div class="mb-3">
              <h3 class="h6 text-uppercase text-muted">{{ group.replace('_',' ') }}</h3>
              <div class="row g-3">
                {% for label, value in entries.items() %}
                  <div class="col-md-4">
                    <label class="form-label">{{ label }}</label>
                    <input name="budget::{{ group }}::{{ label }}" class="form-control" value="{{ value }}">
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </section>

        <section class="mb-4">
          <h2 class="h5">4. Sheet Inputs</h2>
          {% for sheet, entries in cell_inputs.items() %}
            <details class="mb-3" open>
              <summary class="fw-semibold">{{ sheet }}</summary>
              <div class="row g-3 mt-2">
                {% for coord, value in entries.items() %}
                  <div class="col-md-3">
                    <label class="form-label">{{ coord }}</label>
                    <input name="cell::{{ sheet }}::{{ coord }}" class="form-control" value="{{ value }}">
                  </div>
                {% endfor %}
              </div>
            </details>
          {% endfor %}
        </section>

        {% if row_ranges %}
        <section class="mb-4">
          <h2 class="h5">5. Row Ranges (MonthlyCF)</h2>
          {% for rr in row_ranges %}
            {% set idx = loop.index0 %}
            <div class="row g-3 mb-3">
              <div class="col-md-3">
                <label class="form-label">Sheet</label>
                <input name="row::{{ idx }}::sheet" class="form-control" value="{{ rr.sheet }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">Row</label>
                <input name="row::{{ idx }}::row" class="form-control" value="{{ rr.row }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">Start Col</label>
                <input name="row::{{ idx }}::start_col" class="form-control" value="{{ rr.start_col }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">End Col</label>
                <input name="row::{{ idx }}::end_col" class="form-control" value="{{ rr.end_col }}">
              </div>
              <div class="col-md-3">
                <label class="form-label">Value</label>
                <input name="row::{{ idx }}::value" class="form-control" value="{{ rr.value }}">
              </div>
            </div>
          {% endfor %}
        </section>
        {% endif %}

        <div class="mt-4">
          <button class="btn btn-primary w-100" type="submit" name="action" value="generate">Generate Workbook</button>
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
